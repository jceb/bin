#!/bin/bash
TERMINAL="st"
SHELL="/bin/zsh"

# DEBUG
# exec 1>/tmp/x 2>&1
# echo "${@}"
# set -x

# tput smm enables 8 bit shell input
# ENABLE_8_BIT="tput smm;"
ENABLE_8_BIT=""

command=("${TERMINAL}")

#first_session="$(tmux list-sessions | sed -n -e '1s/:.*//p')"
first_detached_session="$(tmux list-sessions | grep -v '(attached)$' | sed -n -e '1s/:.*//p')"
if [ $# -eq 0 ] && [ -n "${first_detached_session}" ] ; then
    command+=("-e" "${SHELL}" "-c" "${ENABLE_8_BIT} exec tmux attach-session -t '${first_detached_session}'")
#elif [ -z "${@}" ] && [ -n "${first_session}" ] ; then
#	exec "${TERMINAL}" -e "${SHELL}" -c "tput smm; exec tmux attach-session -t '${first_session}'"
else
	session="new-session"

	# specify the window's class
	if [ "${1}" = '-c' ]; then
		command+=("-c" "${2}")
		shift 2
	fi

	# attach a specifc tmux session
	if [ "${1}" = '-s' ]; then
		sessionname="${2}"
		shift 2
		if tmux has-session -t "${sessionname}"; then
			session="attach-session -t '${sessionname}'"
		else
			session="new-session -s '${sessionname}'"
		fi
	fi

	# strip -e, all following commands will be handed to tmux' new-session
	if [ "${1}" = '-e' ]; then
		shift 1
	fi

	# start a new session
	if [ $# -ge 1 ]; then
		command+=("-e" "${SHELL}" "-c" "${ENABLE_8_BIT} exec tmux ${session} '${*}'")
	else
		command+=("-e" "${SHELL}" "-c" "${ENABLE_8_BIT} exec tmux ${session}")
	fi
fi
TMUX= exec "${command[@]}"
