#!/bin/bash
# dwm startup script

. ~/.zsh/rc/env.zsh

# enable ibus
export GTK_IM_MODULE=ibus
export QT_IM_MODULE=ibus
export QT4_IM_MODULE=ibus
export CLUTTER_IM_MODULE=ibus
export XMODIFIERS=@im=ibus

# force XFT
export GDK_USE_XFT=1
export QT_XFT=true

# somehow the graphics system seems to be broken with current versions of QT
export QT_GRAPHICSSYSTEM=native
export QT_QPA_PLATFORMTHEME=qt5ct
# export XDG_CURRENT_DESKTOP=KDE

# set wallpaper
#display -window root $HOME/wallpaper0.jpg
#(DISPLAY=${DISPLAY}.1 display -window root $HOME/wallpaper1.jpg) &
#DISPLAY=${DISPLAY}.1 habak -hi $HOME/wallpaper1.jpg -mc 90,90,90,200 -mh 20 -mp 10,850 -mf /usr/share/fonts/truetype/msttcorefonts/Trebuchet_MS.ttf -ht "`verse`"
#habak -hi $HOME/wallpaper0.jpg -mc 90,90,90,200 -mh 20 -mp 10,850 -mf /usr/share/fonts/truetype/msttcorefonts/Trebuchet_MS.ttf -ht "`verse`"
# imlibsetroot -x e -s /usr/share/archlinux/wallpaper/arch_paint_2_1920x1080.png

# enable natural scrolling
naturalscrolling

# update mouse pointer
xsetroot -cursor_name left_ptr

# start the gpg-agent
if [ ! -e '/etc/X11/Xsession.d/90gpg-agent' ]; then
	eval $(gpg-agent --daemon)
	export GPG_AGENT_INFO
fi

# start ssh-agent
if [ ! -e '/etc/X11/Xsession.d/90x11-common_ssh-agent' ]; then
    eval $(ssh-agent)
fi

if [ -e "${HOME}/.Xkbmap" ]; then
    setxkbmap $(cat "${HOME}/.Xkbmap")
fi
if [ -e "${HOME}/.Xmodmap" ]; then
    xmodmap $(cat "${HOME}/.Xmodmap")
fi

# start window manager
# if test -e "${HOME}/.Xresources"; then
# 	xrdb "$HOME/.Xresources"
# fi
dwm &

# autostart programs
dex -a -e DWM

# set screensaver to start after 10 minutes
xset s $((10*60))
xset s on

# set repeat settings
xset r rate 300 30

# turn bell off
xset b off

# everything has been started, wait here for dwm to terminate
wait %1

# kill certain programs that survive the window manager's end
killall gpg-agent &>/dev/null || true
killall dbus-daemon &>/dev/null || true
