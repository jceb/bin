#!/bin/bash
# dwm startup script

echo "Starting dwm: $(date)"

. ~/.zsh/rc/env.zsh

set -x

# enable ibus
export GTK_IM_MODULE=ibus
export QT_IM_MODULE=ibus
export QT4_IM_MODULE=ibus
export CLUTTER_IM_MODULE=ibus
export XMODIFIERS=@im=ibus

# force XFT
export GDK_USE_XFT=1
export QT_XFT=true

export AWT_TOOLKIT="MToolkit"
export _JAVA_AWT_WM_NONREPARENTING="1"
export _JAVA_OPTIONS='-Dawt.useSystemAAFontSettings=gasp'

# somehow the graphics system seems to be broken with current versions of QT
export QT_GRAPHICSSYSTEM=native
export QT_QPA_PLATFORMTHEME=qt5ct
export QT_QPA_PLATFORM_PLUGIN_PATH=/usr/lib
# disable autoscaling
export QT_AUTO_SCREEN_SCALE_FACTOR=0
export XDG_CONFIG_DIRS=/etc/xdg
# export XDG_CURRENT_DESKTOP=XFCE
export XDG_DATA_DIRS=/usr/local/share:/usr/share

# start the gpg-agent
if [ ! -e '/etc/X11/Xsession.d/90gpg-agent' ]; then
    if ! pgrep -U "${USER}" gpg-agent; then
        eval $(gpg-agent --daemon)
        export GPG_AGENT_INFO
    fi
fi

# start ssh-agent
if [ ! -e '/etc/X11/Xsession.d/90x11-common_ssh-agent' ]; then
    if ! pgrep -U "${USER}" ssh-agent; then
        eval $(ssh-agent)
    fi
fi

# load Xresources in case the X11 configuration doesn't do it
# if test -e "${HOME}/.Xresources"; then
# 	xrdb "$HOME/.Xresources"
# fi

# set keymap aso.
fixxmodmap

# start window manager
# autostart programs
# dwm &
# dex -a -e DWM
xmonad --recompile
xmonad &
dex -a -e XMONAD

# everything has been started, wait here for dwm to terminate
wait %1 || true

# kill certain programs that survive the window manager's end
killall gpg-agent &>/dev/null || true
killall dbus-daemon &>/dev/null || true
