#!/usr/bin/env -S make -f

# Dependencies:
# - curl
# - decktape
# - jq
# - pandoc
# - sass
# - unzip

# ---
# title: slides by mdpress
# variant: reveal
# html: index.html
# pdf: slides.pdf
# pdf_size: 1189x841  # 1024x768  # 1280x720
# pdf_delay: 100
# width: 960
# height: 700
# margin: 0.1
# minScale: 0.2
# maxScale: 1.5
# standalone:
# asciinema: false
# theme: black
# transition: slide  # none/fade/slide/convex/concave/zoom
# controls: false
# controlsTutorial: false
# controlsLayout: bottom-right
# controlsBackArrows: faded
# progress: true
# defaultTiming: 120
# slideNumber: false
# history: true
# keyboard: true
# overview: true
# center: true
# touch: true
# loop: false
# rtl: false
# shuffle: false
# fragments: true
# fragmentInURL: true
# embedded: false
# help: true
# showNotes: false
# autoPlayMedia: null
# autoSlide: 0
# autoSlideStoppable: true
# autoSlideMethod: Reveal.navigateNext
# mouseWheel: false
# hideAddressBar: true
# previewLinks: false
# transitionSpeed: default  # default/fast/slow
# backgroundTransition: fade  # none/fade/slide/convex/concave/zoom
# viewDistance: 3
# highlight_style: zenburn
# ---

html: .build/config.json sass slides.html

pdf: html slides.pdf

slides.pdf: slides.html
	pdf="$$(jq -r '.pdf' < .build/config.json)"; \
		pdf_size="$$(jq -r '.pdf_size' < .build/config.json)"; \
		pdf_delay="$$(jq -r '.pdf_delay' < .build/config.json)"; \
		decktape -p $${pdf_delay} -s $${pdf_size} http://localhost:3000/slides.html $@
		# decktape -s $${pdf_size} http://localhost:3000/slides.html $${pdf}

assets/reveal.js: ${HOME}/.config/mdpress/reveal.js/dist
	mkdir -p assets
	ln -s $< $@

.build:
	mkdir -p $@

.template-metadata-extract: .build
	echo '$$meta-json$$' > $@

.build/defaults.yaml: .build
	echo -e '---\ntitle: slides by mdpress\nvariant: reveal\nhtml: index.html\npdf: slides.pdf\npdf_size: 1189x841\npdf_delay: 400\nwidth: 960\nheight: 700\nmargin: 0.1\nminScale: 0.2\nmaxScale: 1.5\nstandalone:\nasciinema: false\ntheme: black\ntransition: slide\ncontrols: false\ncontrolsTutorial: false\ncontrolsLayout: bottom-right\ncontrolsBackArrows: faded\nprogress: true\ndefaultTiming: 120\nslideNumber: false\nhistory: true\nkeyboard: true\noverview: true\ncenter: true\ntouch: true\nloop: false\nrtl: false\nshuffle: false\nfragments: true\nfragmentInURL: true\nembedded: false\nhelp: true\nshowNotes: false\nautoPlayMedia: null\nautoSlide: 0\nautoSlideStoppable: true\nautoSlideMethod: Reveal.navigateNext\nmouseWheel: false\nhideAddressBar: true\npreviewLinks: false\ntransitionSpeed: default\nbackgroundTransition: fade\nviewDistance: 3\nhighlight_style: zenburn\n---' > $@

.build/config.json: slides.md  .build/defaults.yaml .template-metadata-extract
	pandoc --template=.template-metadata-extract -f markdown+yaml_metadata_block .build/defaults.yaml $< > $@
	# yq . .build/defaults.yaml | jq -s '.[0] * .[1]' - .build/config.json.tmp > $@

# .build/slides.md: slides.md .build/config.json
# 	pandoc $< -o $@.tmp.md
# 	echo '---' > $@
# 	# yq . .build/defaults.yaml | jq -s '.[0] * .[1]' - .build/config.json | yq -y . >> $@
# 	yq -y . .build/config.json >> $@
# 	echo '---' >> $@
# 	echo >> $@
# 	# cat $@.tmp.md >> $@
# 	cat $< >> $@

slides.html: slides.md .build/config.json assets/reveal.js
	PANDOC_ARGS=; \
	theme="$$(jq -r '.theme' < .build/config.json)"; \
	[ -e "$${HOME}/.config/mdpress/theme/$${theme}/include-in-header" ] && PANDOC_ARGS="$${PANDOC_ARGS} --include-in-header=$${HOME}/.config/mdpress/theme/$${theme}/include-in-header"; \
	[ -e "$${HOME}/.config/mdpress/theme/$${theme}/include-before-body" ] && PANDOC_ARGS="$${PANDOC_ARGS} --include-before-body=$${HOME}/.config/mdpress/theme/$${theme}/include-before-body"; \
	[ -e "$${HOME}/.config/mdpress/theme/$${theme}/include-after-body" ] && PANDOC_ARGS="$${PANDOC_ARGS} --include-after-body=$${HOME}/.config/mdpress/theme/$${theme}/include-after-body"; \
	pandoc \
		.build/defaults.yaml \
		slides.md \
		-f markdown+yaml_metadata_block \
		-t revealjs \
		--wrap=preserve \
		--standalone \
		--slide-level=2 \
		-V revealjs-url=assets/reveal.js \
		-o $@ \
		$${PANDOC_ARGS} \

${HOME}/.config/mdpress/theme:
	mkdir -p $@

${HOME}/.config/mdpress/reveal.js:
	mkdir -p $@
	curl -L https://github.com/hakimel/reveal.js/archive/master.zip -o $@/master.zip
	unzip $@/master.zip -d $@
	rm $@/master.zip
	mv $@/reveal.js-master/.??* $@/reveal.js-master/* $@
	rmdir $@/reveal.js-master
	# workarounds for the new reveal-js release
	cd $@/dist; \
		ln -s . css; \
		ln -s . js; \
		ln -s ../plugin .;
	cd $@/dist/plugin; \
		ln -s zoom zoom-js;

${HOME}/.config/mdpress/reveal.js/dist: ${HOME}/.config/mdpress/reveal.js

sass: ${HOME}/.config/mdpress/reveal.js \
	.sync-custom-themes \
	.build-themes \
	.link-theme-assets

.sync-custom-themes: $(wildcard ${HOME}/.config/mdpress/theme/*/source/*.scss)
	rsync -u $^ ${HOME}/.config/mdpress/reveal.js/css/theme/source/

.build-themes: $(addprefix ${HOME}/.config/mdpress/reveal.js/dist/theme/,$(addsuffix .css,$(basename $(notdir $(wildcard ${HOME}/.config/mdpress/reveal.js/css/theme/source/*.scss)))))

.SECONDEXPANSION:
.link-theme-assets: $$(addprefix ${HOME}/.config/mdpress/reveal.js/dist/theme/,$$(basename $$(notdir $$(wildcard ${HOME}/.config/mdpress/reveal.js/css/theme/source/*.scss))))

${HOME}/.config/mdpress/reveal.js/dist/theme/%.css: ${HOME}/.config/mdpress/reveal.js/css/theme/source/%.scss
	sass $< $@

${HOME}/.config/mdpress/theme/%/assets:
	mkdir -p $@

${HOME}/.config/mdpress/reveal.js/dist/theme/%: ${HOME}/.config/mdpress/theme/%/assets
	ln -s $< $@

clean:
	rm -f slides.html .template-metadata-extract assets/reveal.js slides.pdf
	rm -rf .build

distclean: clean
	rm -rf ${HOME}/.config/mdpress/reveal.js

.PHONY: build clean distclean
