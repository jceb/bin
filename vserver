#!/bin/bash
# open files in a vim server

# initialization {{{1
set -e
set -u

SERVER=
if [[ "$(basename "$0")" = 'gserver' ]]; then
    # this is not quite exact - gserver â†’ gvim is not equal to creating a global
    # session
	SERVER='-g'
elif [[ "$(basename "$0")" = 'nserver' ]]; then
	SERVER='-e'
fi

# enforce editor to make it work better with tmux and ranger
if [[ "${SERVER}" = '-g' ]]; then
	EDITOR="${REALEDITOR:=/usr/bin/gvim}"
elif [[ "${SERVER}" = '-e' ]]; then
    if [[ -e "${HOME}/.local/bin/nvim" ]]; then
        EDITOR="${REALEDITOR:=${HOME}/.local/bin/nvim}"
    else
        EDITOR="${REALEDITOR:=/usr/bin/nvim}"
    fi
else
	EDITOR="${REALEDITOR:=/usr/bin/vim}"
fi

NVIM_SESSION_DIR="${NVIM_SESSION_DIR:=$HOME/.cache/nvim_sessions}"
export NVIM_SESSION_DIR
mkdir -p "${NVIM_SESSION_DIR}"

cmd=("${EDITOR}")
session="$(vsession "${SERVER}")"

if [[ "${SERVER}" = '-e' ]]; then  # neovim {{{1
	# neovim server path
	if [[ -e "${NVIM_SESSION_DIR}/${session}" ]]; then
		pythoncmd="from neovim import attach; nvim = attach('socket', path='${NVIM_SESSION_DIR}/${session}')"
		cmd=('python' '-c')
		if [[ $# -ge 1 ]]; then
			if [[ "${1}" = '--' ]] || [[ "${1:0:1}" != '-' ]]; then
				# if the first arguments start with - it's an option to vim which will
				# not be executed in a remote session

				# strip --
				if [[ "${1}" = '--' ]]; then
					shift
				fi

				if [[ $# -ge 1 ]]; then
					for i in "${@}"; do
						if [[ -n "${i}" ]] && ([[ "${i:0:1}" = '/' ]] || [[ "${i:0:1}" = '~' ]]); then
							pythoncmd="${pythoncmd}; nvim.command('e ${i}')"
						else
							pythoncmd="${pythoncmd}; nvim.command('e ${PWD}/${i}')"
						fi
						shift
					done
					cmd+=("${pythoncmd}")
				fi
			fi
		fi
	else
		if [[ $# -ge 1 ]]; then
			if [[ "${1}" = '--' ]] || [[ "${1:0:1}" != '-' ]]; then
				# if the first arguments start with - it's an option to vim which will
				# not be executed in a remote session

				# strip --
				if [[ "${1}" = '--' ]]; then
					shift
				fi
			fi
		fi
	fi
else  # vim {{{1
	# vim server path
	cmd+=(--servername "${session}")
	if [[ $# -ge 1 ]]; then
		if [[ "${1}" = '--' ]] || [[ "${1:0:1}" != '-' ]]; then
			# if the first arguments start with - it's an option to vim which will
			# not be executed in a remote session

			# strip --
			if [[ "${1}" = '--' ]]; then
				shift
			fi

			# connect to a remote session
			if [[ $# -ge 1 ]]; then
				cmd+=(--remote-silent)
			fi
		fi
	fi
fi
cmd+=("$@")

# start session {{{1
if [[ "${SERVER}" = '-e' ]]; then
	NVIM_LISTEN_ADDRESS="${NVIM_SESSION_DIR}/${session}" exec "${cmd[@]}"
else
	exec "${cmd[@]}"
fi

# vi: ft=sh:tw=80:sw=4:ts=4:sts=4:noet:fdm=marker
