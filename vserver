#!/bin/bash
# open files in a vim server

set -e
set -u

GLOBAL=
if [ "$(basename "$0")" = "gserver" ]; then
	GLOBAL="-g"
fi

# enforce editor to make it work better with tmux and ranger
if [ -n "${GLOBAL}" ]; then
	EDITOR="${REALEDITOR:=/usr/bin/gvim}"
else
	EDITOR="${REALEDITOR:=/usr/bin/vim}"
fi

cmd=("${EDITOR}")

if [ $# -ge 1 ] && ([ "${1}" = '-h' ] || [ "${1}" = '--help' ]); then
	# pass parameters directly to vim
	cmd+=("${@}")
	exec "${cmd[@]}"
elif [ $# -ge 1 ] && [ "${1}" = '--' ]; then
	# strip file separator to prevent it from being interpreted as a file
	shift
fi

if [ $# -ge 1 ]; then
	cmd+=(--servername "$(vsession "${GLOBAL}")" --remote-silent "$@")
else
	cmd+=(--servername "$(vsession "${GLOBAL}")")
fi
exec "${cmd[@]}"
